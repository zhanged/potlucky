<li id="<%= feed_item.id %>">
<% if current_page?(root_url) || current_page?('/gathers') %>
	<a href="#" onclick="toggle_visibility('gather<%= feed_item.id %>'); return false">
<% end %>
  	<div class="activity">
  		<% if feed_item.activity.present? && feed_item.activity_2.blank? && feed_item.activity_3.blank? %>
  			<%= feed_item.activity %>
  		<% elsif (feed_item.date_2.blank? && feed_item.date_3.blank? && feed_item.time_2.blank? && feed_item.time_3.blank?) && (feed_item.date.present? || feed_item.time.present?) %>
  			Hang out <%= "on " + feed_item.date.strftime("%A, %b %e") if feed_item.date.present? %> <%= "@" + feed_item.time.strftime("%l:%M%p") if feed_item.time.present? %>	
  		<% elsif feed_item.location_2.blank? && feed_item.location_3.blank? && feed_item.location.present? %>
  			Hang out at <%= feed_item.location %>
  		<% else %>
  			Hang out
  		<% end %>

  		<% if feed_item.more_details.present? || feed_item.details.present? || feed_item.updates.present?  %>
  			<% if current_page?(root_url) || current_page?('/gathers') %>
  				<div id="elip">&bull;&bull;&bull;</div>
  			<% end %>
  		<% end %>
  	</div>
<% if current_page?(root_url) || current_page?('/gathers') %>
	</a>
<% end %>	
	<% if feed_item.date.present? || feed_item.time.present? || feed_item.location.present? %>
		<span class="tilt">
			<%= feed_item.date.strftime("%A, %b %e") if feed_item.date.present? %>
			<% if feed_item.time.present? && feed_item.date.present? %>@<% end %>
			<%= feed_item.time.strftime("%l:%M%p") if feed_item.time.present? %>
			<% if feed_item.location.present? && (feed_item.date.present? || feed_item.time.present?) %><br><%end%>
			<% if feed_item.location.present? %>
				<img src="/location.png" width="11"> <%= feed_item.location %>
			<% end %>
		</span>
	<% end %> 
	<div class="tilt-real">
		<% if feed_item.tilt == nil %>
		<% else %>
			<% if (feed_item.num_joining) >= feed_item.tilt %>
				<b><%= "It's taken off!" %></b>
			<% else %>
			<%= feed_item.tilt - feed_item.num_joining %> more to take off
			<% end %>
		<% end %> 
	</div>

	<span class="invited"><div class="user_avatars">
	<% feed_item.invitations.each do |invitation| %>
		<% if invitation.status == "Yes" %>
				<div id="circle-yes">
					<% if current_page?(root_url) || current_page?('/gathers') %>
						<% if invitation.invitee == current_user %>
							<a href="<%= root_url %>" title="<%= invitation.invitee.name %>">
						<% else %>
							<a href="<%= user_path(invitation.invitee) %>" title="<%= invitation.invitee.name %>">
						<% end %>
					<% end %>
					<% if invitation.invitee == feed_item.user %><b><% end %>
					<% if invitation.invitee.name.present? %>
						<%= invitation.invitee.name.at(0.1).upcase %>
					<% else %>
						<%= invitation.invitee.email.at(0.1).upcase %>
					<% end %>
					<% if invitation.invitee == feed_item.user %></b><% end %>
				</a>
			</div>
		<% end %>
	<% end %>

	<% feed_item.invitations.each do |invitation| %>
		<% if invitation.status == "NA" %>
				<div id="circle-no">
					<% if current_page?(root_url) || current_page?('/gathers') %>
						<% if invitation.invitee == current_user %>
							<a href="<%= root_url %>" title="<%= invitation.invitee.name %>">
						<% else %>
							<a href="<%= user_path(invitation.invitee) %>" title="<%= invitation.invitee.name %>">
						<% end %>
					<% end %>
					<% if invitation.invitee == feed_item.user %><b><% end %>
					<% if invitation.invitee.name.present? %>
						<%= invitation.invitee.name.at(0.1).upcase %>
					<% else %>
						<%= invitation.invitee.email.at(0.1).upcase %>
					<% end %>
					<% if invitation.invitee == feed_item.user %></b><% end %>
				</a>
		</div>
		<% end %>
		<!-- 		<%= link_to gravatar_for(invitation.invitee, size:30), invitation.invitee %> -->
	<% end %>

	<% if current_page?(root_url) %>
		<a href="#rebloon" onclick="reBloon(<%= feed_item.invited.to_json %>, 'tags', 'gather_form')" title="Use this group in a new activity">
			<img src='rebloon_h.png' onmouseover="this.src='rebloon.png'"
	         onmouseout="this.src='rebloon_h.png'" title="Use this group in a new activity" width="20" style= 'vertical-align: middle; padding: 4px; margin-bottom: 4px;'>
	     </a>
	<% end %>
	<% if current_page?(root_url) && feed_item.completed.blank? && feed_item.invitations.find_by(invitee_id: current_user.id).status == "Yes" %>
		<a href="#" onclick="toggle_visibility('invite_more<%= feed_item.id %>'); return false">
			<img src='add_more.png' onmouseover="this.src='add_more_h.png'"
	         onmouseout="this.src='add_more.png'" title="Invite more friends" width="20" style= 'vertical-align: middle; padding: 4px; margin-bottom: 4px;'>
		</a>
	<% end %>
	</div>
	<div id="invite_more<%= feed_item.id %>" class="invite_more" style="display:none;">
		<%= form_for(InviteMore.new) do |f| %>
			<%= render 'shared/error_messages', object: f.object %>
			<div class="field-in-gather-no">
				<%= f.hidden_field :user_id, :value => current_user.id %>
				<%= f.hidden_field :gather_id, :value => feed_item.id %>
				<textarea class="tags" name="invite_more[more_invitees]" placeholder="friend1@email.com, friend2@email.com" size="40"></textarea>
			</div>
			<%= f.submit "Invite More", class: "btn btn-block btn-large btn-update-no" %>
		<% end %>
	</div>
	<% if feed_item.user_id == current_user.id %>
		<div>
			Seen by:
			<% feed_item.links.each do |link| %>
				<% if link.seen != nil && link.invitation_id.present? %>
					<%= User.find_by(id: Invitation.find_by(id: link.invitation_id).invitee_id).name %>, 
				<% end %>
			<% end %>
			<% if feed_item.links.find_by(invitation_id: nil).seen != nil %>
					<%= pluralize(feed_item.links.find_by(invitation_id: nil).seen, 'anonymous') %>
				
			<% end %>
		</div>
	<% end %>
	<div class="inside_card">
		<div id="gather<%= feed_item.id %>" style="display:none;">
			<% if feed_item.more_details.present? %>
					<p class="in-card-h">Details</p>
					<p class="in-card-p"><%= feed_item.more_details %></p>
			<% end %>

			<% if feed_item.updates.present? %>
				<p class="in-card-h">Updates</p>
				<p class="in-card-p">
					<% feed_item.updates.pluck(:id).each do |i| %>
						<%= User.find_by(id: Update.find_by(id: i).user_id).name.split(' ').first %>: <%= Update.find_by(id: i).content %><br>
				
					<% end %>
				</p>
			<% end %>

			<% if feed_item.details.present? %>
					<p class="in-card-h">Conversation</p>
					<p class="in-card-p">	
						<% feed_item.details.split("<br>").each do |message| %>
							<% if message != " " %>
								<%= message %><br>
							<% end %>
						<% end %>
					</p>
			<% end %>

		<% if current_page?(root_url) %>
			<% if feed_item.completed.blank? %>
				<% if feed_item.user == current_user %>
					<p class="in-card-h">Send update to all invitees</p>
					<%= form_for(Update.new) do |f| %>
						<%= render 'shared/error_messages', object: f.object %>
						<div class="field-in-gather-org">
							<%= f.hidden_field :user_id, :value => current_user.id %>
							<%= f.hidden_field :gather_id, :value => feed_item.id %>
							<textarea name="update[content]" placeholder="e.g. Tix almost out, join within hour" size="40"></textarea>
						</div>
						<%= f.submit "Send update to all", class: "btn btn-block btn-large btn-update-org" %>
					<% end %>
				<% elsif feed_item.invitations.find_by(invitee_id: current_user.id).status == "NA" %>
					<p class="in-card-h">Send message to organizer</p>
					<%= form_for(Update.new) do |f| %>
						<%= render 'shared/error_messages', object: f.object %>
						<div class="field-in-gather-no">
							<%= f.hidden_field :user_id, :value => current_user.id %>
							<%= f.hidden_field :gather_id, :value => feed_item.id %>
							<textarea name="update[content]" placeholder="Can't make it bc..." size="40"></textarea>
						</div>
						<%= f.submit "Respond to organizer", class: "btn btn-block btn-large btn-update-no" %>
					<% end %>
				<% end %>
			<% end %>
		<% end %>

		<p class="in-card-p"><small>
			Organized by <%= feed_item.user.name %> <%= time_ago_in_words(feed_item.created_at) %> ago
				<% if current_user?(feed_item.user) %>
		  			<%= link_to "delete", feed_item, method: :delete, data: { confirm: "You sure?" } %>
		  		<% end %>
		</small></p>
	</div>
	</div></span>

	<% if !request.path.match(/^\/users/) %>
		<% if feed_item.tilt.present? && feed_item.completed.blank? %>
			<span><%= render 'shared/join_form', :feed_item => feed_item %></span> <!-- USED TO BE :feed_item => feed_item -->
		<% end %>
		<% if feed_item.completed.present? %>
			<span class="completed">Completed</span>
		<% end %>
	<% end %>
</li>